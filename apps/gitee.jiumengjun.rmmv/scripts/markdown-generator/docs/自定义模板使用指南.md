# jsdoc2md 自定义模板使用指南

## 问题背景

在使用 jsdoc2md 生成文档时，默认模板会将返回类型渲染为包含锚点链接的 Markdown 格式：

```markdown
## allocate() ⇒ [<code>CacheEntry</code>](#CacheEntry)
```

这种格式在某些文档工具（如 VitePress）中可能导致渲染异常或显示错误。理想的输出格式应该是简洁的代码标签形式：

```markdown
## allocate() ⇒ <code>CacheEntry</code>
```

## 解决方案

### 1. 自定义模板文件说明

为了解决上述问题，本项目提供了三个自定义模板文件：

- `partials/shared/signature/sig-link.hbs` - 修改后的函数签名模板（移除链接）
- `partials/shared/value/linked-type-list.hbs` - 修改后的类型列表模板（移除链接）
- `partials/shared/value/link.hbs` - 修改后的链接模板（只保留代码标签）

### 2. 使用方法

#### 方法一：直接覆盖默认模板（推荐）

dmd 通过文件名（去除 .hbs 后缀）注册 Handlebars partial。要覆盖默认模板，只需提供同名的自定义模板文件即可。

```javascript
const jsdoc2md = require("jsdoc-to-markdown");

const output = await jsdoc2md.render({
	files: "src/**/*.js",
	// 指定自定义模板文件，同名模板会覆盖默认模板
	partial: [
		"./partials/shared/signature/sig-link.hbs",
		"./partials/shared/value/linked-type-list.hbs",
		"./partials/shared/value/link.hbs",
	],
});
```

#### 方法二：复制完整模板目录

如需对模板进行大量定制，可复制整个 dmd 模板目录：

```bash
# 复制 dmd 默认模板到项目目录
cp -r node_modules/dmd/partials ./custom-templates/
```

修改所需的模板文件后，在代码中引用：

```javascript
const jsdoc2md = require("jsdoc-to-markdown");

const output = await jsdoc2md.render({
	files: "src/**/*.js",
	partial: "./custom-templates/**/*.hbs",
});
```

### 3. 模板修改详情

#### sig-link.hbs（函数签名模板）

- **修改内容**：移除了 Markdown 链接语法 `[...](...)`，保留 `<code>` 标签
- **效果**：函数签名中的返回类型不再生成锚点链接

#### linked-type-list.hbs（类型列表模板）

- **修改内容**：调用修改后的 `link` partial 而非默认的链接生成逻辑
- **效果**：类型列表中的每个类型都使用无链接的代码格式

#### link.hbs（链接模板）

- **修改内容**：移除所有链接生成逻辑，始终输出 `<code>name</code>` 格式
- **效果**：所有类型引用都显示为简单的代码标签，不包含任何链接

### 4. 效果对比

**使用默认模板：**

```markdown
## allocate() ⇒ [<code>CacheEntry</code>](#CacheEntry)
```

**使用自定义模板：**

```markdown
## allocate() ⇒ <code>CacheEntry</code>
```

### 5. 注意事项

1. **模板路径**：确保模板文件路径相对于执行目录的正确性
2. **缓存清理**：修改模板后建议清理 jsdoc2md 缓存以确保生效
3. **兼容性测试**：建议先在小范围内测试，确认输出效果符合预期
4. **版本依赖**：确保 jsdoc-to-markdown 版本支持 `partial` 选项

### 6. 完整代码示例

```javascript
const jsdoc2md = require("jsdoc-to-markdown");
const path = require("path");

async function generateCleanDocs() {
	try {
		const output = await jsdoc2md.render({
			files: "src/**/*.js",
			// 使用自定义模板覆盖默认模板
			partial: [
				path.join(__dirname, "partials/shared/signature/sig-link.hbs"),
				path.join(__dirname, "partials/shared/value/linked-type-list.hbs"),
				path.join(__dirname, "partials/shared/value/link.hbs"),
			],
		});

		console.log("Documentation generated successfully");
		return output;
	} catch (error) {
		console.error("Error generating documentation:", error);
		throw error;
	}
}

// 使用示例
generateCleanDocs()
	.then((docs) => {
		// 输出文档或写入文件
		console.log(docs);
	})
	.catch((error) => {
		console.error("Generation failed:", error);
	});
```

### 7. 工作原理

**模板注册机制：**

- dmd 使用 `handlebarsTemplate.handlebars.registerPartial(name, content)` 注册模板
- 模板名称 `name` 对应文件名（去除 `.hbs` 后缀）
- 外部模板在内置模板之后加载，因此同名模板会覆盖默认模板

**覆盖顺序：**

1. 首先加载内置模板（来自 dmd 包）
2. 然后加载通过 `partial` 选项指定的外部模板
3. 同名模板会覆盖之前注册的模板

通过这种机制，你可以有选择性地替换特定模板，而无需修改整个模板体系。
